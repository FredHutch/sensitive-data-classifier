{% extends "base.html" %}

{% block title %}Downloads - PHI Classifier{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="fas fa-download me-2"></i>Download Generated Files
        </h2>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-file-archive text-primary me-2"></i>Download All Files
                </h5>
                <p class="card-text">Download all generated synthetic health data files as a single ZIP archive.</p>
                <button id="download-all-btn" class="btn btn-primary">
                    <i class="fas fa-download me-2"></i>Download All as ZIP
                </button>
                <div id="download-all-status" class="mt-2"></div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-sync text-success me-2"></i>Refresh File List
                </h5>
                <p class="card-text">Reload the list of available files from the server.</p>
                <button id="refresh-btn" class="btn btn-success">
                    <i class="fas fa-sync me-2"></i>Refresh List
                </button>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>Available Files
            <span id="file-count-badge" class="badge bg-light text-dark ms-2">0</span>
        </h5>
    </div>
    <div class="card-body">
        <div id="loading-spinner" class="text-center py-5" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading files...</p>
        </div>

        <div id="no-files-message" class="alert alert-info" style="display: none;">
            <i class="fas fa-info-circle me-2"></i>
            No files available yet. Generate synthetic data to create files.
        </div>

        <div id="files-table-container" style="display: none;">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th><i class="fas fa-file me-1"></i>Filename</th>
                            <th><i class="fas fa-hdd me-1"></i>Size</th>
                            <th><i class="fas fa-clock me-1"></i>Created</th>
                            <th><i class="fas fa-download me-1"></i>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="files-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const filesList = document.getElementById('files-table-body');
    const filesContainer = document.getElementById('files-table-container');
    const noFilesMessage = document.getElementById('no-files-message');
    const loadingSpinner = document.getElementById('loading-spinner');
    const fileCountBadge = document.getElementById('file-count-badge');
    const refreshBtn = document.getElementById('refresh-btn');
    const downloadAllBtn = document.getElementById('download-all-btn');
    const downloadAllStatus = document.getElementById('download-all-status');

    function formatBytes(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function formatDate(isoString) {
        const date = new Date(isoString);
        return date.toLocaleString();
    }

    async function loadFiles() {
        loadingSpinner.style.display = 'block';
        filesContainer.style.display = 'none';
        noFilesMessage.style.display = 'none';

        try {
            const response = await fetch('/api/downloads/list');
            const data = await response.json();

            loadingSpinner.style.display = 'none';

            if (data.files && data.files.length > 0) {
                filesContainer.style.display = 'block';
                fileCountBadge.textContent = data.count;

                filesList.innerHTML = data.files.map(file => `
                    <tr>
                        <td>
                            <i class="fas fa-file-alt me-2 text-primary"></i>
                            <strong>${file.filename}</strong>
                        </td>
                        <td>${formatBytes(file.size_bytes)}</td>
                        <td>${formatDate(file.created)}</td>
                        <td>
                            <a href="${file.download_url}" class="btn btn-sm btn-primary" download>
                                <i class="fas fa-download me-1"></i>Download
                            </a>
                        </td>
                    </tr>
                `).join('');
            } else {
                noFilesMessage.style.display = 'block';
                fileCountBadge.textContent = '0';
            }
        } catch (error) {
            loadingSpinner.style.display = 'none';
            noFilesMessage.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error loading files: ${error.message}
            `;
            noFilesMessage.classList.remove('alert-info');
            noFilesMessage.classList.add('alert-danger');
            noFilesMessage.style.display = 'block';
        }
    }

    refreshBtn.addEventListener('click', loadFiles);

    downloadAllBtn.addEventListener('click', async function() {
        downloadAllStatus.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Preparing download...';
        downloadAllStatus.className = 'mt-2 text-info';

        try {
            const response = await fetch('/api/downloads/zip');

            if (!response.ok) {
                throw new Error('No files available');
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `synthetic_health_data_${new Date().toISOString().slice(0,10)}.zip`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            downloadAllStatus.innerHTML = '<i class="fas fa-check-circle me-2"></i>Download complete!';
            downloadAllStatus.className = 'mt-2 text-success';

            setTimeout(() => {
                downloadAllStatus.innerHTML = '';
            }, 3000);
        } catch (error) {
            downloadAllStatus.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>Error: ${error.message}`;
            downloadAllStatus.className = 'mt-2 text-danger';
        }
    });

    // Load files on page load
    loadFiles();
});
</script>
{% endblock %}
